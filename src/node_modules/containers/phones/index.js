import React, {Component} from 'react';
import Select from 'react-select';
import Search from 'components/search';
import 'react-select/dist/react-select.css';
import {connect} from 'react-redux';
import {
	fetchPhones, 
	loadMorePhones,
	addPhoneToBasket,
	fetchCategories
} from 'actions';
import {getPhones} from 'selectors';
import {Link} from 'react-router';
import R from 'ramda';

class Phones extends Component {

	constructor(props) {
		super(props);
		this.state = {
			option: "1",
			sortDirection: true,
			sortField: 'price'
		}
	}

	componentDidMount() {
		this.props.fetchPhones()
		this.props.fetchCategories()
	}

		renderPhone(phone, index) {
			const {addPhoneToBasket} = this.props;
			const shortInfo = `Описание: ${R.take(60, phone.info)}...`;
			const quantity = phone.qty > 0 ? true : false;
			return (
				<div className='col-sm-4 col-lg-4 col-md-4 book-list' key={index}>
					<div className='thumbnail'>
						<img 
							className='img-thumbnail' 
							src={phone.image}  
							alt={phone.name} 
						/>
						<div className='caption'>
							<h4 className='pull-right'>${phone.price}</h4>
							<h4>
								<Link to={`/phones/${phone.id}`}>
									{phone.name}
								</Link>
							</h4>
							<p>{shortInfo}</p>
							<p>
								<span>Наличие: </span>
								{quantity && <span className='item-qty-true'>Есть</span>}
								{!quantity && <span className='item-qty-false'>Нет</span>}
							</p>
							<p className='itemButton'>
								<button 
									className='btn btn-primary'
									onClick={() => addPhoneToBasket(phone.id)}
								>
									Buy now
								</button>
								<Link to={`/phones/${phone.id}`} className='btn btn-default'>More info</Link>
							</p>
						</div>
					</div>
				</div>
			)
		}

		sorting(items, field, sd) {
			if (field === 'price') {
				let sortList = R.sortBy(R.prop(field));
				sd ? sortList = sortList(items) : sortList = R.reverse(sortList(items))
				return sortList
			} else if (field === 'qty') {
				let sortList = R.sortBy(R.prop(field));
				return R.reverse(sortList(items))
			}
		}

		logChange(e) {
			this.setState({
				...this.state,
				option: e.value,
				sortDirection: e.direction,
				sortField: e.fieldd
			})
		}

		render() {
			const options = [
				{ value: '1', label: 'По возростанию цены', direction: true, fieldd: 'price' },
				{ value: '2', label: 'По убыванию цены', direction: false, fieldd: 'price' },
				{ value: '3', label: 'По наличию', direction: false, fieldd: 'qty' },
			];
			let {phones, loadMorePhones} = this.props;
			phones = this.sorting(phones, this.state.sortField, this.state.sortDirection);
				return (
						<div>
							<div className='sort-list'>
								<div className='field-search-select search-field'>
									<Search />
								</div>
								<div className='field-search-select select-field'>
									<div className='sort-list-left'>
										<p>Сортировка: </p>
									</div>
									<div className='sort-list-right'>
										<Select
											name="form-field-name"
											value={this.state.option}
											options={options}
											onCloseResetsInput={false}
											onChange={this.logChange.bind(this)}
										/>
									</div>
								</div>
							</div>
							<div className='books row'>
								{phones.map((phone, index) => this.renderPhone(phone, index))}
							</div>
							<div className='row'>
								<div className='col=md-12'>
									<button 
										className='pull-rigth btn btn-primary'
										onClick={loadMorePhones}
									>
										Load more...
									</button>
								</div>
							</div>
						</div>
				)
		}
}

const mapStateToProps = (state, ownProps) => {
	return {
		phones: getPhones(state, ownProps)
	}
}

const mapDispatchToProps = {
		fetchPhones,
		loadMorePhones,
		addPhoneToBasket,
		fetchCategories
}

export default connect(mapStateToProps, mapDispatchToProps)(Phones);